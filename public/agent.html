<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InfiNET Voice — Agent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071025;--card:#081224;--muted:#9fb0c8;--accent:#00c2d4}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:420px;max-width:96vw;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));box-shadow:0 12px 40px rgba(2,6,23,0.6)}
    .title{font-weight:700;font-size:16px}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .primary{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white}
    .muted{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .status{margin-top:10px;color:var(--muted);font-weight:600}
    audio{display:none}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <div class="title">InfiNET Voice — Agent</div>

    <div style="margin-top:12px">
      <label>Session ID (auto)</label>
      <input id="sessionId" placeholder="session id will be auto-filled" readonly />
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="answerBtn" class="btn primary">Start & Answer</button>
        <button id="hangBtn" class="btn muted">Hang up</button>
        <button id="refreshBtn" class="btn muted">Refresh ID</button>
      </div>
      <div id="status" class="status">idle</div>
      <div id="meta" class="small" style="margin-top:8px"></div>
    </div>

    <audio id="remoteAudio" autoplay playsinline></audio>
  </div>

  <script src="/webrtc-client.js"></script>
  <script>
    (async () => {
      const sessionIdEl = document.getElementById("sessionId");
      const answerBtn = document.getElementById("answerBtn");
      const hangBtn = document.getElementById("hangBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const statusEl = document.getElementById("status");
      const metaEl = document.getElementById("meta");
      const remoteAudio = document.getElementById("remoteAudio");

      function setStatus(t) { statusEl.textContent = t; }

      const client = await window.WebRTCClient.init({ remoteAudioEl: remoteAudio, onState: (s) => setStatus(s), autoGetMic: false });

      async function fetchLatestSession() {
        try {
          setStatus("fetching latest session...");
          const resp = await fetch("/api/sessions/latest");
          if (!resp.ok) {
            sessionIdEl.value = "";
            metaEl.textContent = "No active session yet";
            setStatus("idle");
            return null;
          }
          const data = await resp.json();
          sessionIdEl.value = data.sessionId || "";
          metaEl.textContent = `consent: ${data.consent ? 'yes' : 'no'}`;
          setStatus("latest session loaded");
          return data.sessionId;
        } catch (e) {
          console.warn("fetch latest failed", e);
          setStatus("fetch failed");
          return null;
        }
      }

      // auto fetch on load
      await fetchLatestSession();

      refreshBtn.addEventListener("click", async () => {
        await fetchLatestSession();
      });

      answerBtn.addEventListener("click", async () => {
        const sid = sessionIdEl.value.trim();
        if (!sid) return alert("No session id available yet. Click refresh or wait for caller to start.");
        try {
          setStatus("starting & answering...");
          try { await client.getLocalStream(); } catch (e) {}
          await client.join(sid, { isCaller: false, metadata: { role: "agent" } });
          setStatus("joined");
          metaEl.textContent = `Joined session ${sid}`;
        } catch (e) {
          console.error("answer err", e);
          setStatus("answer failed");
        }
      });

      hangBtn.addEventListener("click", () => {
        client.close();
        setStatus("hung up");
      });

    })();
  </script>
</body>
</html>