<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Splynx Agent Widget (Demo)</title>
  <style>
    body { font-family: system-ui, Arial; }
    #widget { width: 320px; border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
    #messages { height: 260px; overflow:auto; border:1px solid #eee; padding:8px; margin-bottom:8px; background:#fafafa; }
    .m { margin:6px 0; }
    .m.user { text-align:right; }
    .m.assistant { text-align:left; color:#0b5; }
    #inputRow { display:flex; gap:6px; }
    #txt { flex:1; padding:8px; }
  </style>
</head>
<body>
  <div id="widget">
    <div id="messages"></div>
    <div id="inputRow">
      <input id="txt" placeholder="Say something..." />
      <button id="send">Send</button>
    </div>
  </div>

  <script src="/widget.js"></script>
</body>
</html> -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ISP Support Chat Widget â€” Integrated</title>
  <style>
    :root{--bg-1:#071025;--card:#081224;--muted:#9fb0c8;--accent:#00c2b3;--accent-2:#3b82f6;--glass: rgba(255,255,255,0.03);--radius:14px;--ease:cubic-bezier(.2,.9,.2,1);font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,#031022 0%, #071425 100%);display:flex;align-items:center;justify-content:center;height:100vh;margin:0;padding:20px;color:#e6eef8}
    .widget{width:380px;max-width:calc(100% - 40px);border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 12px 40px rgba(2,6,23,0.6);overflow:hidden;border:1px solid rgba(255,255,255,0.04);transform:translateZ(0)}
    .header{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(90deg, rgba(59,130,246,0.06), rgba(0,194,179,0.04));}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:grid;place-items:center;color:white;font-weight:700;font-size:16px;box-shadow:0 6px 18px rgba(59,130,246,0.08)}
    .title{line-height:1}
    .title h4{margin:0;font-size:15px}
    .title p{margin:0;color:var(--muted);font-size:12px}
    .header-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    .status{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:linear-gradient(180deg,#34d399,#10b981)}
    .dot.offline{background:#666}
    .min-btn{background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:14px;padding:6px;border-radius:8px}
    .messages-wrap{padding:14px;height:420px;display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.01));}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
    .bubble-row{display:flex;align-items:flex-end;gap:10px}
    .msg{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.4;font-size:14px;box-shadow:0 6px 18px rgba(2,6,23,0.45);opacity:0;transform:translateY(6px);animation:pop .28s var(--ease) forwards}
    @keyframes pop{to{opacity:1;transform:none}}
    .msg.agent{align-self:flex-start;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);color:#e7f7f4;border-radius:12px 12px 12px 6px}
    .msg.user{align-self:flex-end;background:linear-gradient(135deg,var(--accent-2),var(--accent));color:white;border-radius:12px 12px 6px 12px}
    .avatar{width:36px;height:36px;border-radius:8px;background:#091127;display:inline-grid;place-items:center;color:#bfeef0;font-weight:600}
    .meta{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:11px;color:var(--muted)}
    .composer{padding:12px 14px;background:linear-gradient(180deg, rgba(2,6,23,0.35), rgba(2,6,23,0.45));display:flex;gap:10px;align-items:flex-end}
    .input-wrap{flex:1;display:flex;flex-direction:column;gap:6px}
    textarea{width:100%;min-height:44px;max-height:120px;resize:none;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:inherit;font-size:14px;outline:none}
    .hint{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent-2),var(--accent));border:none;padding:10px 12px;border-radius:10px;color:white;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:0.6;cursor:default}
    .typing{display:inline-block;padding:6px 10px;border-radius:12px;background:rgba(255,255,255,0.03)}
    .dots{display:inline-flex;gap:4px}
    .dots span{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:0.6;animation:blink 1.2s infinite}
    .dots span:nth-child(2){animation-delay:0.15s}
    .dots span:nth-child(3){animation-delay:0.3s}
    @keyframes blink{0%{opacity:0.15}50%{opacity:0.9}100%{opacity:0.15}}
    .messages::-webkit-scrollbar{width:8px}
    .messages::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.03);border-radius:10px}
    .collected-badge{font-size:11px;color:var(--muted);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
    @media (max-width:420px){.widget{width:100%;height:100%;border-radius:0}.messages-wrap{height:calc(100vh - 200px)}}
  </style>
</head>
<body>
  <div class="widget" role="region" aria-label="ISP support chat widget">
    <div class="header">
      <div class="brand">
        <div class="logo">ISP</div>
        <div class="title">
          <h4>InfiNET Support</h4>
          <p>Fast help â€” outages, billing, upgrades</p>
        </div>
      </div>

      <div class="header-controls">
        <div class="status" id="status">
          <div class="dot online" id="statusDot"></div>
          <div id="statusText">Online</div>
        </div>
        <div class="collected-badge" id="collectedBadge" style="display:none">Collected: â€”</div>
        <button class="min-btn" id="minBtn" aria-label="Minimize">â€”</button>
      </div>
    </div>

    <div class="messages-wrap" id="messagesWrap">
      <div id="messages" class="messages" aria-live="polite"></div>
    </div>

    <div class="composer">
      <div class="input-wrap">
        <textarea id="txt" placeholder="Describe your issue (Shift+Enter newline, Enter to send)" aria-label="Message input"></textarea>
        <div class="hint"><span id="charCount">0</span><span style="color:var(--muted)">Press Enter to send</span></div>
      </div>
      <button class="btn" id="send">Send</button>
    </div>
  </div>

  <script>
    (async ()=>{
      const messagesEl = document.getElementById('messages');
      const txt = document.getElementById('txt');
      const send = document.getElementById('send');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const minBtn = document.getElementById('minBtn');
      const messagesWrap = document.getElementById('messagesWrap');
      const charCount = document.getElementById('charCount');
      const collectedBadge = document.getElementById('collectedBadge');

      let sessionId = null;
      let minimized = false;
      let busy = false;

      function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

      function addMessage({from='agent', text='', meta='', audioBase64=null}){
        const row = document.createElement('div'); row.className = 'bubble-row';
        const wrapper = document.createElement('div'); wrapper.className = 'msg '+(from==='user'?'user':'agent');
        wrapper.innerHTML = `<div class="text">${escapeHtml(text)}</div>`;

        if (from === 'agent'){
          const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent='A';
          row.appendChild(avatar);
          row.appendChild(wrapper);
        } else {
          row.appendChild(wrapper);
        }

        const metaEl = document.createElement('div'); metaEl.className='meta'; metaEl.textContent = meta || timeNow();
        row.appendChild(metaEl);

        if (audioBase64){
          const play = document.createElement('button'); play.className='min-btn'; play.textContent='ðŸ”Š'; play.title='Play audio';
          play.addEventListener('click', ()=> playAudioBase64(audioBase64));
          metaEl.appendChild(play);
        }

        messagesEl.appendChild(row);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return wrapper;
      }

      function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function setStatus(isOnline){ statusDot.className = 'dot ' + (isOnline ? 'online' : 'offline'); statusText.textContent = isOnline ? 'Online' : 'Offline'; }

      function toggleMin(){ minimized = !minimized; if (minimized){ messagesWrap.style.display = 'none'; document.querySelector('.composer').style.display = 'none'; minBtn.textContent = '+'; } else { messagesWrap.style.display=''; document.querySelector('.composer').style.display=''; minBtn.textContent='â€”'; txt.focus(); } }

      function setBusy(v){ busy = !!v; send.disabled = busy; if (busy) send.setAttribute('aria-busy','true'); else send.removeAttribute('aria-busy'); }

      function playAudioBase64(b64){ try{
        const audio = new Audio('data:audio/mpeg;base64,' + b64);
        audio.play().catch(()=>{ /* autoplay may be blocked; ignore */ });
      }catch(e){console.warn('play audio err',e);} }

      async function init(){
        setBusy(true);
        try{
          const r = await fetch('/api/chat/init',{method:'POST',headers:{'Content-Type':'application/json'}});
          if (!r.ok) throw new Error('Init failed: '+r.status);
          const j = await r.json();
          sessionId = j.sessionId;
          localStorage.setItem('isp_chat_session', sessionId);
          addMessage({from:'agent', text: j.text || 'Hi â€” I\'m your ISP assistant. How can I help today?', audioBase64: j.audioBase64 || null, meta: ''});
          if (j.audioBase64) playAudioBase64(j.audioBase64);
          setStatus(true);
        }catch(e){ console.error('init err',e); addMessage({from:'agent', text:'Unable to connect to the chat service. Please try again later.'}); setStatus(false); }
        finally{ setBusy(false); }
      }

      async function sendMessage(message){
        if (!message || busy) return;
        setBusy(true);
        addMessage({from:'user', text: message});

        // typing indicator
        const typingNode = document.createElement('div'); typingNode.className='msg agent'; typingNode.innerHTML = '<div class="typing"><span class="dots"><span></span><span></span><span></span></span> Thinkingâ€¦</div>';
        messagesEl.appendChild(typingNode); messagesEl.scrollTop = messagesEl.scrollHeight;

        try{
          const resp = await fetch('/api/chat/message',{
            method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId,message,channel:'web'})
          });
          if (!resp.ok) throw new Error('message error '+resp.status);
          const j = await resp.json();

          // remove typing
          if (typingNode && typingNode.parentNode) typingNode.parentNode.removeChild(typingNode);

          if (j?.text) addMessage({from:'agent', text: j.text, meta: ''});
          if (j?.audioBase64) { addMessage({from:'agent', text: '', audioBase64: j.audioBase64}); playAudioBase64(j.audioBase64); }

          if (j?.collected) {
            collectedBadge.style.display = '';
            collectedBadge.textContent = 'Collected: ' + Object.keys(j.collected).join(', ') || 'â€”';
            console.log('collected fields', j.collected);
          }

        }catch(err){
          if (typingNode && typingNode.parentNode) typingNode.parentNode.removeChild(typingNode);
          console.error('send err', err);
          addMessage({from:'agent', text:'Sorry â€” something went wrong sending your message. Please try again.'});
          setStatus(false);
        }finally{
          setBusy(false);
          txt.value = '';
          charCount.textContent = '0';
          txt.focus();
        }
      }

      // events
      send.addEventListener('click', ()=>{ const m = txt.value.trim(); if(!m) return; sendMessage(m); });
      txt.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send.click(); } });
      txt.addEventListener('input', ()=>{ charCount.textContent = txt.value.length; });
      minBtn.addEventListener('click', toggleMin);

      // initialize
      await init();
      txt.focus();
    })();
  </script>
</body>
</html>